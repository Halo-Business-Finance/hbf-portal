name: Deploy IBM Functions to Code Engine

on:
  push:
    branches: [main]
    paths:
      - 'ibm-functions/**'
  workflow_dispatch:

env:
  IBM_REGION: us-south
  CE_PROJECT: hbf-functions
  APP_NAME: hbf-api
  REGISTRY: us.icr.io
  NAMESPACE: hbf-registry
  IMAGE_NAME: hbf-functions

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install IBM Cloud CLI
        run: curl -fsSL https://clis.cloud.ibm.com/install/linux | sh

      - name: Install plugins
        run: |
          ibmcloud plugin install container-registry -f
          ibmcloud plugin install code-engine -f

      - name: Login to IBM Cloud
        run: |
          ibmcloud login --apikey ${{ secrets.IBM_CLOUD_API_KEY }} -r ${{ env.IBM_REGION }} -g ${{ secrets.IBM_RESOURCE_GROUP }}

      - name: Login to Container Registry
        run: ibmcloud cr login

      - name: Build & push image
        working-directory: ibm-functions
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Select Code Engine project
        run: ibmcloud ce project select --name ${{ env.CE_PROJECT }}

      - name: Deploy or update application
        run: |
          if ibmcloud ce app get --name ${{ env.APP_NAME }} > /dev/null 2>&1; then
            ibmcloud ce app update \
              --name ${{ env.APP_NAME }} \
              --image ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --env DATABASE_URL="${{ secrets.IBM_DATABASE_URL }}" \
              --env IBM_DB_CA_CERT="${{ secrets.IBM_DB_CA_CERT }}" \
              --env JWT_SECRET="${{ secrets.SUPABASE_JWT_SECRET }}" \
              --env IBM_CLOUD_API_KEY="${{ secrets.IBM_CLOUD_API_KEY }}" \
              --env IBM_APPID_TENANT_ID="${{ secrets.IBM_APPID_TENANT_ID }}" \
              --env IBM_APPID_CLIENT_ID="${{ secrets.IBM_APPID_CLIENT_ID }}" \
              --env IBM_APPID_SECRET="${{ secrets.IBM_APPID_SECRET }}" \
              --env IBM_APPID_OAUTH_SERVER_URL="${{ secrets.IBM_APPID_OAUTH_SERVER_URL }}" \
              --env IBM_COS_API_KEY="${{ secrets.IBM_COS_API_KEY }}" \
              --env IBM_COS_ENDPOINT="${{ secrets.IBM_COS_ENDPOINT }}" \
              --env IBM_COS_BUCKET="${{ secrets.IBM_COS_BUCKET }}" \
              --env IBM_COS_INSTANCE_ID="${{ secrets.IBM_COS_INSTANCE_ID }}" \
              --min-scale 1 \
              --max-scale 5 \
              --cpu 0.5 \
              --memory 1G \
              --port 8080
          else
            ibmcloud ce app create \
              --name ${{ env.APP_NAME }} \
              --image ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --env DATABASE_URL="${{ secrets.IBM_DATABASE_URL }}" \
              --env IBM_DB_CA_CERT="${{ secrets.IBM_DB_CA_CERT }}" \
              --env JWT_SECRET="${{ secrets.SUPABASE_JWT_SECRET }}" \
              --env IBM_CLOUD_API_KEY="${{ secrets.IBM_CLOUD_API_KEY }}" \
              --env IBM_APPID_TENANT_ID="${{ secrets.IBM_APPID_TENANT_ID }}" \
              --env IBM_APPID_CLIENT_ID="${{ secrets.IBM_APPID_CLIENT_ID }}" \
              --env IBM_APPID_SECRET="${{ secrets.IBM_APPID_SECRET }}" \
              --env IBM_APPID_OAUTH_SERVER_URL="${{ secrets.IBM_APPID_OAUTH_SERVER_URL }}" \
              --env IBM_COS_API_KEY="${{ secrets.IBM_COS_API_KEY }}" \
              --env IBM_COS_ENDPOINT="${{ secrets.IBM_COS_ENDPOINT }}" \
              --env IBM_COS_BUCKET="${{ secrets.IBM_COS_BUCKET }}" \
              --env IBM_COS_INSTANCE_ID="${{ secrets.IBM_COS_INSTANCE_ID }}" \
              --min-scale 1 \
              --max-scale 5 \
              --cpu 0.5 \
              --memory 1G \
              --port 8080
          fi

      - name: Health check
        run: |
          APP_URL=$(ibmcloud ce app get --name ${{ env.APP_NAME }} --output url)
          echo "Deployed at: $APP_URL"
          sleep 15
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/health" || echo "000")
            echo "Health check attempt $i: $STATUS"
            if [ "$STATUS" = "200" ]; then exit 0; fi
            sleep 10
          done
          echo "Health check failed"
          exit 1
